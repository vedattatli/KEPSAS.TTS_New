@model KEPSAS.TTS.Models.Talep
@{
    ViewData["Title"] = "Talep Detay";
    var isAdmin = User.IsInRole("Admin");
}

<h3>Talep Detay</h3>
<hr />

<div class="row g-3">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-body">
                <h4 class="card-title">@Model.Baslik</h4>
                <p class="card-text">@Model.Aciklama</p>

                <dl class="row">
                    <dt class="col-sm-4">Tip</dt>
                    <dd class="col-sm-8">@Model.Tip</dd>

                    @if (Model.Tip == KEPSAS.TTS.Models.TalepTipi.Donanim)
                    {
                        <dt class="col-sm-4">Donanım</dt>
                        <dd class="col-sm-8">@Model.Donanim?.Kategori - @Model.Donanim?.Model (@Model.Donanim?.SeriNo)</dd>
                    }
                    @if (Model.Tip == KEPSAS.TTS.Models.TalepTipi.Yazilim)
                    {
                        <dt class="col-sm-4">Yazılım</dt>
                        <dd class="col-sm-8">@Model.YazilimAdi</dd>
                    }

                    <dt class="col-sm-4">Durum</dt>
                    <dd class="col-sm-8">@Model.Durum</dd>

                    <dt class="col-sm-4">Oluşturan</dt>
                    <dd class="col-sm-8">@Model.OlusturanKullanici?.UserName</dd>

                    <dt class="col-sm-4">Atanan</dt>
                    <dd class="col-sm-8">@Model.AtananKullanici?.UserName ?? "-"</dd>

                    <dt class="col-sm-4">Hedef Personel</dt>
                    <dd class="col-sm-8">@Model.HedefKullanici?.UserName ?? ("-" + (Model.HedefSicilNo ?? ""))</dd>

                    <dt class="col-sm-4">IP</dt>
                    <dd class="col-sm-8">@Model.IpAdresi</dd>

                    <dt class="col-sm-4">Oluşturma</dt>
                    <dd class="col-sm-8">@Model.OlusturmaTarihi.ToLocalTime()</dd>
                </dl>

                @if (!string.IsNullOrWhiteSpace(Model.IptalNedeni))
                {
                    <div class="alert alert-warning">
                        <strong>İptal Nedeni:</strong> @Model.IptalNedeni
                    </div>
                }
            </div>
        </div>
    </div>

    @if (isAdmin)
    {
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">Atama</div>
                <div class="card-body">
                    <form asp-action="Assign" method="post">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="mb-2">
                            <select name="userId" class="form-select" asp-items="(IEnumerable<SelectListItem>)ViewBag.AssignableUsers">
                                <option value="">(Atama kaldır)</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <input name="note" class="form-control" placeholder="Not (opsiyonel)" />
                        </div>
                        <button class="btn btn-primary w-100" type="submit">Kaydet</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Durum</div>
                <div class="card-body">
                    <form asp-action="SetStatus" method="post" class="mb-2">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="input-group">
                            <select name="durum" class="form-select">
                                <option>Yeni</option>
                                <option>Üzerimde</option>
                                <option>Onaylı</option>
                                <option>Tamamlandı</option>
                            </select>
                            <button class="btn btn-success" type="submit">Güncelle</button>
                        </div>
                    </form>

                    <form asp-action="Cancel" method="post">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="input-group">
                            <input name="reason" class="form-control" placeholder="İptal nedeni" />
                            <button class="btn btn-danger" type="submit">İptal Et</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
</div>
